# LLM Backend State Machine

**Last Updated:** 2026-02-06  
**Status:** Optimized (v2.0)

## Architecture Changes (v2.0)

| Component | Before | After |
|-----------|--------|-------|
| **Validation** | Duplicated in 3 functions | Centralized in `utils.py` |
| **Formatting** | 60+ lines in `chat.py` | `formatters.py` module |
| **CSV Repair** | `_robust_csv_repair` inline | `repair_csv()` in utils |
| **LLM Parsing** | Inline regex per handler | `extract_json_array()` shared |
| **Imports** | 6 inline `import` statements | Module-level imports |

---

## Main Flow Diagram


```
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚           SESSION START             â”‚
                                    â”‚  session_id = "session-{timestamp}" â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                       â”‚
                                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                         IDLE STATE                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ConversationContext:                                                                 â”‚    â”‚
â”‚  â”‚   - conversation_history: List[{role, content}]                                      â”‚    â”‚
â”‚  â”‚   - wordlist: List[str]           # [] initially                                     â”‚    â”‚
â”‚  â”‚   - raw_csv: Optional[str]        # None initially                                   â”‚    â”‚
â”‚  â”‚   - binary_matrix_csv: Optional[str]                                                 â”‚    â”‚
â”‚  â”‚   - clustered_csv: Optional[str]                                                     â”‚    â”‚
â”‚  â”‚   - geojson: Optional[Dict]                                                          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                       â”‚
                                                       â”‚ POST /api/v1/chat
                                                       â”‚ {messages, model, provider, api_key, session_id, uploaded_file?}
                                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    PROCESSING STATE                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Actions:                                                                             â”‚    â”‚
â”‚  â”‚   1. context = orchestrator.get_context(session_id)                                  â”‚    â”‚
â”‚  â”‚   2. user_message = messages[-1].content                                             â”‚    â”‚
â”‚  â”‚   3. if uploaded_file: context.raw_csv = uploaded_file                               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                       â”‚
                                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                  BUILD SYSTEM PROMPT                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Components:                                                                          â”‚    â”‚
â”‚  â”‚   - context_info = context.to_dict()                                                 â”‚    â”‚
â”‚  â”‚       has_wordlist: bool                                                             â”‚    â”‚
â”‚  â”‚       wordlist_size: int                                                             â”‚    â”‚
â”‚  â”‚       has_raw_data: bool                                                             â”‚    â”‚
â”‚  â”‚       has_matrix: bool                                                               â”‚    â”‚
â”‚  â”‚       has_clustered: bool                                                            â”‚    â”‚
â”‚  â”‚   - tool_list = [server.tools for server in MCP_SERVERS]                             â”‚    â”‚
â”‚  â”‚   - behavioral_rules (conversational-first, tool examples)                           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                       â”‚
                                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                      LLM CALL                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ call_llm_with_messages(conversation, provider, model, api_key, base_url)             â”‚    â”‚
â”‚  â”‚                                                                                      â”‚    â”‚
â”‚  â”‚ Providers:                                                                           â”‚    â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚    â”‚
â”‚  â”‚   â”‚   ollama    â”‚  â”‚   openai    â”‚  â”‚  anthropic  â”‚  â”‚   gemini    â”‚                â”‚    â”‚
â”‚  â”‚   â”‚ /api/chat   â”‚  â”‚ /v1/chat/   â”‚  â”‚ /v1/messagesâ”‚  â”‚ /v1beta/    â”‚                â”‚    â”‚
â”‚  â”‚   â”‚             â”‚  â”‚ completions â”‚  â”‚             â”‚  â”‚ generateContâ”‚                â”‚    â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚    â”‚
â”‚  â”‚                                                                                      â”‚    â”‚
â”‚  â”‚ Timeout: 120s                                                                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                       â”‚
                                                       â”‚ llm_response: str
                                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                   RESPONSE PARSING                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Tool Detection Regex:                                                                â”‚    â”‚
â”‚  â”‚   pattern = r'\{"server"\s*:\s*"([^"]+)",\s*"tool"\s*:\s*"([^"]+)"'                  â”‚    â”‚
â”‚  â”‚                                                                                      â”‚    â”‚
â”‚  â”‚ If match found:                                                                      â”‚    â”‚
â”‚  â”‚   tool_call = {                                                                      â”‚    â”‚
â”‚  â”‚     "server": "wordlist_discovery" | "linguistic_web_harvester" | ...                â”‚    â”‚
â”‚  â”‚     "tool": "propose_wordlist" | "collect_multilingual_rows" | ...                   â”‚    â”‚
â”‚  â”‚     "params": {...}                                                                  â”‚    â”‚
â”‚  â”‚   }                                                                                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚                                        â”‚
                              â”‚ No tool call                           â”‚ Tool call found
                              â–¼                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         CONVERSATIONAL RESPONSE             â”‚    â”‚              TOOL DISPATCH                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ return ChatResponse(                  â”‚  â”‚    â”‚  â”‚ server_name = tool_call["server"]   â”‚  â”‚
â”‚  â”‚   role="assistant",                   â”‚  â”‚    â”‚  â”‚ tool_name = tool_call["tool"]       â”‚  â”‚
â”‚  â”‚   content=cleaned_response,           â”‚  â”‚    â”‚  â”‚ params = tool_call["params"]        â”‚  â”‚
â”‚  â”‚   tool_data=None                      â”‚  â”‚    â”‚  â”‚                                     â”‚  â”‚
â”‚  â”‚ )                                     â”‚  â”‚    â”‚  â”‚ handler = TOOL_HANDLERS             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚  â”‚            [server_name][tool_name] â”‚  â”‚
â”‚                                             â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚                                                 â”‚
                       â”‚                                                 â–¼
                       â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚                           â”‚           PARAM ENRICHMENT               â”‚
                       â”‚                           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                       â”‚                           â”‚  â”‚ Auto-inject context data:           â”‚  â”‚
                       â”‚                           â”‚  â”‚                                     â”‚  â”‚
                       â”‚                           â”‚  â”‚ to_binary_matrix:                   â”‚  â”‚
                       â”‚                           â”‚  â”‚   params["csv_data"] = raw_csv      â”‚  â”‚
                       â”‚                           â”‚  â”‚                                     â”‚  â”‚
                       â”‚                           â”‚  â”‚ cluster:                            â”‚  â”‚
                       â”‚                           â”‚  â”‚   params["csv_data"] = matrix_csv   â”‚  â”‚
                       â”‚                           â”‚  â”‚                                     â”‚  â”‚
                       â”‚                           â”‚  â”‚ to_map_layer:                       â”‚  â”‚
                       â”‚                           â”‚  â”‚   params["csv_data"] = latest_csv   â”‚  â”‚
                       â”‚                           â”‚  â”‚   (clustered > matrix > raw)        â”‚  â”‚
                       â”‚                           â”‚  â”‚                                     â”‚  â”‚
                       â”‚                           â”‚  â”‚ export_csv:                         â”‚  â”‚
                       â”‚                           â”‚  â”‚   params["context_data"] = {        â”‚  â”‚
                       â”‚                           â”‚  â”‚     raw_csv, binary_matrix_csv,     â”‚  â”‚
                       â”‚                           â”‚  â”‚     clustered_csv                   â”‚  â”‚
                       â”‚                           â”‚  â”‚   }                                 â”‚  â”‚
                       â”‚                           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                       â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚                                                 â”‚
                       â”‚                                                 â–¼
                       â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚                           â”‚            TOOL EXECUTION                â”‚
                       â”‚                           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                       â”‚                           â”‚  â”‚ if asyncio.iscoroutinefunction:     â”‚  â”‚
                       â”‚                           â”‚  â”‚   result = await handler(**params,  â”‚  â”‚
                       â”‚                           â”‚  â”‚                    llm_call_fn=...) â”‚  â”‚
                       â”‚                           â”‚  â”‚ else:                               â”‚  â”‚
                       â”‚                           â”‚  â”‚   result = handler(**params)        â”‚  â”‚
                       â”‚                           â”‚  â”‚                                     â”‚  â”‚
                       â”‚                           â”‚  â”‚ LLM-calling tools:                  â”‚  â”‚
                       â”‚                           â”‚  â”‚   - propose_wordlist                â”‚  â”‚
                       â”‚                           â”‚  â”‚   - refine_wordlist                 â”‚  â”‚
                       â”‚                           â”‚  â”‚   - collect_multilingual_rows       â”‚  â”‚
                       â”‚                           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                       â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚                                    â”‚                     â”‚
                       â”‚                           Success  â”‚                     â”‚ Exception
                       â”‚                                    â–¼                     â–¼
                       â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚           â”‚       CONTEXT UPDATE           â”‚  â”‚    ERROR HANDLING       â”‚
                       â”‚           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                       â”‚           â”‚  â”‚ Tool Result Mapping:     â”‚  â”‚  â”‚  â”‚ error_msg =       â”‚  â”‚
                       â”‚           â”‚  â”‚                          â”‚  â”‚  â”‚  â”‚   str(e) or       â”‚  â”‚
                       â”‚           â”‚  â”‚ propose_wordlist:        â”‚  â”‚  â”‚  â”‚   e.__class__     â”‚  â”‚
                       â”‚           â”‚  â”‚   ctx.wordlist = result  â”‚  â”‚  â”‚  â”‚                   â”‚  â”‚
                       â”‚           â”‚  â”‚           ["wordlist"]   â”‚  â”‚  â”‚  â”‚ return ChatResp(  â”‚  â”‚
                       â”‚           â”‚  â”‚                          â”‚  â”‚  â”‚  â”‚   content=        â”‚  â”‚
                       â”‚           â”‚  â”‚ collect_multilingual:    â”‚  â”‚  â”‚  â”‚     llm_text +    â”‚  â”‚
                       â”‚           â”‚  â”‚   ctx.raw_csv = result   â”‚  â”‚  â”‚  â”‚     "âŒ " + msg,  â”‚  â”‚
                       â”‚           â”‚  â”‚           ["csv"]        â”‚  â”‚  â”‚  â”‚   tool_data=None  â”‚  â”‚
                       â”‚           â”‚  â”‚                          â”‚  â”‚  â”‚  â”‚ )                 â”‚  â”‚
                       â”‚           â”‚  â”‚ to_binary_matrix:        â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                       â”‚           â”‚  â”‚   ctx.binary_matrix_csv  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚           â”‚  â”‚     = result["csv"]      â”‚  â”‚              â”‚
                       â”‚           â”‚  â”‚                          â”‚  â”‚              â”‚
                       â”‚           â”‚  â”‚ cluster:                 â”‚  â”‚              â”‚
                       â”‚           â”‚  â”‚   ctx.clustered_csv      â”‚  â”‚              â”‚
                       â”‚           â”‚  â”‚     = result["csv"]      â”‚  â”‚              â”‚
                       â”‚           â”‚  â”‚                          â”‚  â”‚              â”‚
                       â”‚           â”‚  â”‚ to_map_layer:            â”‚  â”‚              â”‚
                       â”‚           â”‚  â”‚   ctx.geojson = result   â”‚  â”‚              â”‚
                       â”‚           â”‚  â”‚           ["geojson"]    â”‚  â”‚              â”‚
                       â”‚           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚              â”‚
                       â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
                       â”‚                          â”‚                                â”‚
                       â”‚                          â–¼                                â”‚
                       â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
                       â”‚           â”‚     RESPONSE FORMATTING        â”‚              â”‚
                       â”‚           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚              â”‚
                       â”‚           â”‚  â”‚ 1. Clean LLM response:   â”‚  â”‚              â”‚
                       â”‚           â”‚  â”‚    - Remove JSON blocks  â”‚  â”‚              â”‚
                       â”‚           â”‚  â”‚    - Remove inline JSON  â”‚  â”‚              â”‚
                       â”‚           â”‚  â”‚    - Collapse newlines   â”‚  â”‚              â”‚
                       â”‚           â”‚  â”‚                          â”‚  â”‚              â”‚
                       â”‚           â”‚  â”‚ 2. Build result summary: â”‚  â”‚              â”‚
                       â”‚           â”‚  â”‚    wordlist â†’ "âœ… X      â”‚  â”‚              â”‚
                       â”‚           â”‚  â”‚              concepts"   â”‚  â”‚              â”‚
                       â”‚           â”‚  â”‚    csv â†’ preview + "ğŸ“¥"  â”‚  â”‚              â”‚
                       â”‚           â”‚  â”‚    geojson â†’ point count â”‚  â”‚              â”‚
                       â”‚           â”‚  â”‚    error â†’ "âŒ message"  â”‚  â”‚              â”‚
                       â”‚           â”‚  â”‚                          â”‚  â”‚              â”‚
                       â”‚           â”‚  â”‚ 3. Return:               â”‚  â”‚              â”‚
                       â”‚           â”‚  â”‚    ChatResponse(         â”‚  â”‚              â”‚
                       â”‚           â”‚  â”‚      content=text+summaryâ”‚  â”‚              â”‚
                       â”‚           â”‚  â”‚      tool_data={         â”‚  â”‚              â”‚
                       â”‚           â”‚  â”‚        tool, server,     â”‚  â”‚              â”‚
                       â”‚           â”‚  â”‚        result            â”‚  â”‚              â”‚
                       â”‚           â”‚  â”‚      }                   â”‚  â”‚              â”‚
                       â”‚           â”‚  â”‚    )                     â”‚  â”‚              â”‚
                       â”‚           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚              â”‚
                       â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
                       â”‚                          â”‚                                â”‚
                       â–¼                          â–¼                                â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚                              IDLE                                      â”‚
                  â”‚                     (waiting for next message)                         â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Tool Handler Registry

```
TOOL_HANDLERS = {
    â”œâ”€â”€ "wordlist_discovery"
    â”‚       â”œâ”€â”€ propose_wordlist(topic, constraints?, llm_call_fn)
    â”‚       â”‚       â†’ {wordlist: [...], notes: "..."}
    â”‚       â””â”€â”€ refine_wordlist(wordlist, feedback, llm_call_fn)
    â”‚               â†’ {wordlist: [...]}
    â”‚
    â”œâ”€â”€ "linguistic_web_harvester"
    â”‚       â””â”€â”€ collect_multilingual_rows(wordlist, scope?, llm_call_fn)
    â”‚               â†’ {csv: "...", prompt: "...", wordlist: [...]}
    â”‚
    â”œâ”€â”€ "csv_ingest_and_validate"
    â”‚       â”œâ”€â”€ read_csv(csv_data)
    â”‚       â”‚       â†’ {columns: [...], row_count: N, preview: [...]}
    â”‚       â”œâ”€â”€ validate_schema(csv_data, required_columns)
    â”‚       â”‚       â†’ {ok: bool, errors: [...], warnings: [...]}
    â”‚       â””â”€â”€ normalize(csv_data)
    â”‚               â†’ cleaned_csv_string
    â”‚
    â”œâ”€â”€ "availability_matrix"
    â”‚       â””â”€â”€ to_binary_matrix(csv_data)
    â”‚               â†’ {csv: "...", summary: {languages, concepts, avg_coverage}}
    â”‚
    â”œâ”€â”€ "clustering_hdbscan"
    â”‚       â””â”€â”€ cluster(csv_data, params?)
    â”‚               â†’ {csv: "...", summary: {total_clusters, clustered_languages, noise}}
    â”‚
    â”œâ”€â”€ "map_layer_builder"
    â”‚       â””â”€â”€ to_map_layer(csv_data, lat_col?, lon_col?, style_by?)
    â”‚               â†’ {geojson: {...}, point_count: N}
    â”‚
    â””â”€â”€ "data_export"
            â””â”€â”€ export_csv(data_source, filename?, context_data?)
                    â†’ {csv: "...", filename: "...", row_count: N, downloadable: true}
```

---

## Validation Gate (Pre-Tool Check)

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   to_binary_matrix          â”‚
                    â”‚   to_map_layer              â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   CSV Row Length Check      â”‚
                    â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
                    â”‚   for each row:             â”‚
                    â”‚     if is_core_schema:      â”‚
                    â”‚       assert len(row) == 8  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                             â”‚
                    â–¼                             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   PASS            â”‚         â”‚   FAIL                        â”‚
        â”‚   â”€â”€â”€â”€            â”‚         â”‚   â”€â”€â”€â”€                        â”‚
        â”‚   Continue to     â”‚         â”‚   return {                    â”‚
        â”‚   pandas.read_csv â”‚         â”‚     error: "Line N has X      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚             fields instead    â”‚
                                      â”‚             of 8. Run         â”‚
                                      â”‚             normalize first." â”‚
                                      â”‚   }                           â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
